// MIT License
//
// Copyright (c) 2025 asv-soft (https://github.com/asv-soft)
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

// This code was generate by tool {{Tool}} version {{ToolVersion}} {{GenerateTime}}.

using System;
using System.Text;
using System.ComponentModel;
using System.Runtime.CompilerServices;
using System.Collections.Immutable;
using Asv.Mavlink.Common;
using Asv.Mavlink.Minimal;
using Asv.Mavlink.AsvAudio;
using System.Linq;
using System.Collections.Generic;
using Asv.IO;

namespace Asv.Mavlink.{{ Namespace }}
{

    public static class {{ Namespace }}Helper
    {
        public static void Register{{ Namespace }}Dialect(this ImmutableDictionary<int,Func<MavlinkMessage>>.Builder src)
        {
            {%- for msg in Messages -%}
            src.Add({{ msg.CamelCaseName }}Packet.MessageId, ()=>new {{ msg.CamelCaseName }}Packet());
            {%- endfor -%}
        }
 
    }

#region Enums

{%- for en in Enums -%}
    /// <summary>
    {%- for line in en.Desc -%}
    /// {{ line }}
    {%- endfor -%}
    ///  {{ en.Name }}
    /// </summary>
    {%- if en.IsFlag -%}
    [Flags]
    {%- endif -%}
    public enum {{ en.CamelCaseName }} : ulong
    {
    {%- for entry in en.Entries -%}
        /// <summary>
        {%- for line in entry.Desc -%}
        /// {{ line }}
        {%- endfor -%}
        {%- for param in entry.Params -%}
        /// Param {{ param.Index }} - {{ param.Desc }}
        {%- endfor -%}
        /// {{ entry.Name }}
        /// </summary>
        {%- if entry.HasMetadataDescription -%}
        [Description("{{ entry.MetadataDescription }}")]
        {%- endif -%}
        {{ entry.CamelCaseName }} = {{ entry.Value }},
    {%- endfor -%}
    }
    public static class {{ en.CamelCaseName }}Helper
    {
        public static IEnumerable<T> GetValues<T>(Func<ulong, T> converter)
        {
            {%- for entry in en.Entries -%}
            yield return converter({{ entry.Value }});
            {%- endfor -%}
        }
        public static IEnumerable<EnumValue<T>> GetEnumValues<T>(Func<ulong,T> converter)
        {
            {%- for entry in en.Entries -%}
            yield return new EnumValue<T>(converter({{ entry.Value }}),"{{ entry.Name }}");
            {%- endfor -%}
        }
    }
{%- endfor -%}

#endregion

#region Messages

{%- for msg in Messages -%}
    /// <summary>
    {%- for line in msg.Desc -%}
    /// {{ line }}
    {%- endfor -%}
    ///  {{ msg.Name }}
    /// </summary>
    public class {{ msg.CamelCaseName }}Packet : MavlinkV2Message<{{ msg.CamelCaseName }}Payload>
    {
        public const int MessageId = {{ msg.Id }};
        
        public const byte CrcExtra = {{ msg.CrcExtra }};
        
        public override int Id => MessageId;
        
        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public override byte GetCrcExtra() => CrcExtra;
        
        public override bool WrapToV2Extension => {{ msg.WrapToV2Extension }};

        public override {{ msg.CamelCaseName }}Payload Payload { get; } = new();

        public override string Name => "{{ msg.Name }}";

{%- if msg.HasTargetSystemIdComponentId -%}
        public override bool TrySetTargetId(byte systemId, byte componentId)
        {
            Payload.TargetSystem = systemId;
            Payload.TargetComponent = componentId;
            return true;
        }
        public override bool TryGetTargetId(out byte systemId, out byte componentId)
        {
            systemId = Payload.TargetSystem;
            componentId = Payload.TargetComponent;
            return true;
        }
{%- endif -%}
    }

    /// <summary>
    ///  {{ msg.Name }}
    /// </summary>
    public class {{ msg.CamelCaseName }}Payload : IPayload
    {
        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public byte GetMaxByteSize() => {{ msg.PayloadByteSize }}; // Sum of byte sized of all fields (include extended)
        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        public byte GetMinByteSize() => {{ msg.PayloadByteSize - msg.ExtendedFieldsLength }}; // of byte sized of fields (exclude extended)
        [MethodImpl(MethodImplOptions.AggressiveOptimization)]
        public int GetByteSize()
        {
            return (byte)(
{%- for field in msg.Fields -%}
    {%- if field.IsEnum -%}
        {%- if field.IsArray -%}
            {%- case field.Type -%}
            {%- when 'char' or 'double' or 'float'-%}
            ERROR => ENUM as 'char' or 'double' or 'float' ???????
            {%- when 'sbyte' or 'byte' -%}
            + {{ field.CamelCaseName }}.Length // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'short' -%}
            + {{ field.CamelCaseName }}.Length * 2 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'ushort' -%}
            + {{ field.CamelCaseName }}.Length * 2 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'int' -%}
            + {{ field.CamelCaseName }}.Length * 4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'uint' -%}
            + {{ field.CamelCaseName }}.Length * 4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'long' -%}
            + {{ field.CamelCaseName }}.Length * 8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'ulong' -%}
            + {{ field.CamelCaseName }}.Length * 8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- endcase -%}
            
        {%- else -%}
            {%- case field.Type -%}
            {%- when 'char' or 'double' or 'float'-%}
            ERROR => ENUM as 'char' or 'double' or 'float' ???????
            {%- when 'sbyte' or 'byte' -%}
            + 1 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'short' -%}
            + 2 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'ushort' -%}
            + 2 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'int' -%}
            + 4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'uint' -%}
            + 4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'long' -%}
            + 8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'ulong' -%}
            + 8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- endcase -%}
        {%- endif -%}
    {%- else -%}
        {%- if field.IsArray -%}
            {%- case field.Type -%}
            {%- when 'char' -%}
            +{{ field.CamelCaseName }}.Length // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'sbyte' or 'byte' -%}
            +{{ field.CamelCaseName }}.Length // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'short' -%}
            +{{ field.CamelCaseName }}.Length * 2 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'ushort' -%}
            +{{ field.CamelCaseName }}.Length * 2 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'int' -%}
            +{{ field.CamelCaseName }}.Length * 4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'uint' -%}
            +{{ field.CamelCaseName }}.Length * 4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'long' -%}
            +{{ field.CamelCaseName }}.Length * 8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'ulong' -%}
            +{{ field.CamelCaseName }}.Length * 8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'float' -%}
            +{{ field.CamelCaseName }}.Length * 4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'double' -%}
            +{{ field.CamelCaseName }}.Length * 8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- endcase -%}
        {%- else -%}
            {%- case field.Type -%}
            {%- when 'char' -%}
            +1 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'sbyte' or 'byte' -%}
            +1 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'short' -%}
            +2 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'ushort' -%}
            +2 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'int' -%}
            +4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'uint' -%}
            +4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'long' -%}
            +8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'ulong' -%}
            +8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'float' -%}
            +4 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- when 'double' -%}
            +8 // {{ field.ULogTypeName }} {{ field.Name }}
            {%- endcase -%}
        {%- endif -%}
    {%- endif -%}
{%- endfor -%}
            );
        }



        public void Deserialize(ref ReadOnlySpan<byte> buffer)
        {
{%- if msg.HasArrayFields -%}
            var arraySize = 0;
            var payloadSize = buffer.Length;
{%- endif -%}
{%- for field in msg.Fields -%}
            {%- if field.IsExtended -%}
            // extended field '{{ field.CamelCaseName }}' can be empty
            if (buffer.IsEmpty) return;
            {%- endif -%}
    {%- if field.IsEnum -%}
        {%- if field.IsArray -%}
            {%- if field.IsTheLargestArrayInMessage -%}
            arraySize = /*ArrayLength*/{{ field.ArrayLength }} - Math.Max(0,((/*PayloadByteSize*/{{ msg.PayloadByteSize }} - payloadSize - /*ExtendedFieldsLength*/{{ msg.ExtendedFieldsLength }})/*FieldTypeByteSize*/ /{{ field.FieldTypeByteSize }}));
            
            {%- else -%}
            arraySize = {{ field.ArrayLength }};
            {%- endif -%}
            for(var i=0;i<arraySize;i++)
            {
                {%- case field.Type -%}
                {%- when 'sbyte' or 'byte'-%}
                {{ field.CamelCaseName }}[i] = ({{ field.EnumCamelCaseName }})BinSerialize.ReadByte(ref buffer);
                {%- when 'short' -%}
                {{ field.CamelCaseName }}[i] = ({{ field.EnumCamelCaseName }})BinSerialize.ReadShort(ref buffer);
                {%- when 'ushort' -%}
                {{ field.CamelCaseName }}[i] = ({{ field.EnumCamelCaseName }})BinSerialize.ReadUShort(ref buffer);
                {%- when 'int' -%}
                {{ field.CamelCaseName }}[i] = ({{ field.EnumCamelCaseName }})BinSerialize.ReadInt(ref buffer);
                {%- when 'uint' -%}
                {{ field.CamelCaseName }}[i] = ({{ field.EnumCamelCaseName }})BinSerialize.ReadUInt(ref buffer);
                {%- when 'long' -%}
                {{ field.CamelCaseName }}[i] = ({{ field.EnumCamelCaseName }})BinSerialize.ReadLong(ref buffer);
                {%- when 'ulong' -%}
                {{ field.CamelCaseName }}[i] = ({{ field.EnumCamelCaseName }})BinSerialize.ReadULong(ref buffer);
                {%- endcase -%}
            }

        {%- else -%}
            {%- case field.Type -%}
            {%- when 'sbyte' or 'byte' -%}
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})BinSerialize.ReadByte(ref buffer);
            {%- when 'short' -%}
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})BinSerialize.ReadShort(ref buffer);
            {%- when 'ushort' -%}
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})BinSerialize.ReadUShort(ref buffer);
            {%- when 'int' -%}
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})BinSerialize.ReadInt(ref buffer);
            {%- when 'uint' -%}
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})BinSerialize.ReadUInt(ref buffer);
            {%- when 'long' -%}
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})BinSerialize.ReadLong(ref buffer);
            {%- when 'ulong' -%}
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})BinSerialize.ReadULong(ref buffer);
            {%- endcase -%}
        {%- endif -%}
    {%- else -%}
        {%- if field.IsArray -%}
            {%- if field.IsTheLargestArrayInMessage -%}
            arraySize = /*ArrayLength*/{{ field.ArrayLength }} - Math.Max(0,((/*PayloadByteSize*/{{ msg.PayloadByteSize }} - payloadSize - /*ExtendedFieldsLength*/{{ msg.ExtendedFieldsLength }})/{{ field.FieldTypeByteSize }} /*FieldTypeByteSize*/));
            
            {%- else -%}
            arraySize = {{ field.ArrayLength }};
            {%- endif -%}
            {%- if field.Type == 'char' -%}
            unsafe
            {
                fixed (byte* bytePointer = buffer)
                fixed (char* charPointer = {{ field.CamelCaseName }})
                {
                    Encoding.ASCII.GetChars(bytePointer, arraySize, charPointer, {{ field.CamelCaseName }}.Length);
                }
            }
            buffer = buffer[arraySize..];
           
            {%- else -%}
            for(var i=0;i<arraySize;i++)
            {
                {%- case field.Type -%}
                {%- when 'sbyte' or 'byte' -%}
                {{ field.CamelCaseName }}[i] = ({{ field.Type }})BinSerialize.ReadByte(ref buffer);
                {%- when 'short' -%}
                {{ field.CamelCaseName }}[i] = BinSerialize.ReadShort(ref buffer);
                {%- when 'ushort' -%}
                {{ field.CamelCaseName }}[i] = BinSerialize.ReadUShort(ref buffer);
                {%- when 'int' -%}
                {{ field.CamelCaseName }}[i] = BinSerialize.ReadInt(ref buffer);
                {%- when 'uint' -%}
                {{ field.CamelCaseName }}[i] = BinSerialize.ReadUInt(ref buffer);
                {%- when 'long' -%}
                {{ field.CamelCaseName }}[i] = BinSerialize.ReadLong(ref buffer);
                {%- when 'ulong' -%}
                {{ field.CamelCaseName }}[i] = BinSerialize.ReadULong(ref buffer);
                {%- when 'float' -%}
                {{ field.CamelCaseName }}[i] = BinSerialize.ReadFloat(ref buffer);
                {%- when 'double' -%}
                {{ field.CamelCaseName }}[i] = BinSerialize.ReadDouble(ref buffer);
                {%- endcase -%}
            }
            {%- endif -%}
        {%- else -%}
            {%- if field.Type == 'char' -%}
            {{ field.CamelCaseName }} = (char)buffer[0];
            buffer = buffer.Slice(1);
            
            {%- else -%}
            {%- case field.Type -%}
            {%- when 'sbyte' or 'byte' -%}
            {{ field.CamelCaseName }} = ({{ field.Type }})BinSerialize.ReadByte(ref buffer);
            {%- when 'short' -%}
            {{ field.CamelCaseName }} = BinSerialize.ReadShort(ref buffer);
            {%- when 'ushort' -%}
            {{ field.CamelCaseName }} = BinSerialize.ReadUShort(ref buffer);
            {%- when 'int' -%}
            {{ field.CamelCaseName }} = BinSerialize.ReadInt(ref buffer);
            {%- when 'uint' -%}
            {{ field.CamelCaseName }} = BinSerialize.ReadUInt(ref buffer);
            {%- when 'long' -%}
            {{ field.CamelCaseName }} = BinSerialize.ReadLong(ref buffer);
            {%- when 'ulong' -%}
            {{ field.CamelCaseName }} = BinSerialize.ReadULong(ref buffer);
            {%- when 'float' -%}
            {{ field.CamelCaseName }} = BinSerialize.ReadFloat(ref buffer);
            {%- when 'double' -%}
            {{ field.CamelCaseName }} = BinSerialize.ReadDouble(ref buffer);
            {%- endcase -%}
            {%- endif -%}
        {%- endif -%}
    {%- endif -%}
{%- endfor -%}

        }

        public void Serialize(ref Span<byte> buffer)
        {
{%- for field in msg.Fields -%}
    {%- if field.IsEnum -%}
        {%- if field.IsArray -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                {%- case field.Type -%}
                {%- when 'char' or 'double' or 'float'-%}
                ERROR => ENUM as 'char' or 'double' or 'float' ???????
                {%- when 'sbyte' or 'byte' -%}
                BinSerialize.WriteByte(ref buffer,(byte){{ field.CamelCaseName }}[i]);
                {%- when 'short' -%}
                BinSerialize.WriteShort(ref buffer,(short){{ field.CamelCaseName }}[i]);
                {%- when 'ushort' -%}
                BinSerialize.WriteUShort(ref buffer,(ushort){{ field.CamelCaseName }}[i]);
                {%- when 'int' -%}
                BinSerialize.WriteInt(ref buffer,(int){{ field.CamelCaseName }}[i]);
                {%- when 'uint' -%}
                BinSerialize.WriteUInt(ref buffer,(uint){{ field.CamelCaseName }}[i]);
                {%- when 'long' -%}
                BinSerialize.WriteLong(ref buffer,(long){{ field.CamelCaseName }}[i]);
                {%- when 'ulong' -%}
                BinSerialize.WriteULong(ref buffer,(ulong){{ field.CamelCaseName }}[i]);
                
                {%- endcase -%}
            }
        {%- else -%}
            {%- case field.Type -%}
            {%- when 'char' or 'double' or 'float'-%}
            ERROR => ENUM as 'char' or 'double' or 'float' ???????
            {%- when 'sbyte' or 'byte' -%}
            BinSerialize.WriteByte(ref buffer,(byte){{ field.CamelCaseName }});
            {%- when 'short' -%}
            BinSerialize.WriteShort(ref buffer,(short){{ field.CamelCaseName }});
            {%- when 'ushort' -%}
            BinSerialize.WriteUShort(ref buffer,(ushort){{ field.CamelCaseName }});
            {%- when 'int' -%}
            BinSerialize.WriteInt(ref buffer,(int){{ field.CamelCaseName }});
            {%- when 'uint' -%}
            BinSerialize.WriteUInt(ref buffer,(uint){{ field.CamelCaseName }});
            {%- when 'long' -%}
            BinSerialize.WriteLong(ref buffer,(long){{ field.CamelCaseName }});
            {%- when 'ulong' -%}
            BinSerialize.WriteULong(ref buffer,(ulong){{ field.CamelCaseName }});
            {%- endcase -%}
        {%- endif -%}
    {%- else -%}
        {%- if field.IsArray -%}
            {%- case field.Type -%}
            {%- when 'char' -%}
            unsafe
            {
                fixed (byte* bytePointer = buffer)
                fixed (char* charPointer = {{ field.CamelCaseName }})
                {
                    Encoding.ASCII.GetBytes(charPointer, {{ field.CamelCaseName }}.Length, bytePointer, {{ field.CamelCaseName }}.Length);
                }
            }
            buffer = buffer.Slice({{ field.CamelCaseName }}.Length);
            
            {%- when 'sbyte' or 'byte' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteByte(ref buffer,(byte){{ field.CamelCaseName }}[i]);
            }
            {%- when 'short' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteShort(ref buffer,{{ field.CamelCaseName }}[i]);
            }
            {%- when 'ushort' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteUShort(ref buffer,{{ field.CamelCaseName }}[i]);
            }
            {%- when 'int' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteInt(ref buffer,{{ field.CamelCaseName }}[i]);
            }
            {%- when 'uint' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteUInt(ref buffer,{{ field.CamelCaseName }}[i]);
            }
            {%- when 'long' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteLong(ref buffer,{{ field.CamelCaseName }}[i]);
            }
            {%- when 'ulong' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteULong(ref buffer,{{ field.CamelCaseName }}[i]);
            }
            {%- when 'float' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteFloat(ref buffer,{{ field.CamelCaseName }}[i]);
            }
            {%- when 'double' -%}
            for(var i=0;i<{{ field.CamelCaseName }}.Length;i++)
            {
                BinSerialize.WriteDouble(ref buffer,{{ field.CamelCaseName }}[i]);
            }
            {%- endcase -%}
        {%- else -%}
            {%- case field.Type -%}
            {%- when 'char' -%}
            BinSerialize.WriteByte(ref buffer,(byte){{ field.CamelCaseName }});
            {%- when 'sbyte' or 'byte' -%}
            BinSerialize.WriteByte(ref buffer,(byte){{ field.CamelCaseName }});
            {%- when 'short' -%}
            BinSerialize.WriteShort(ref buffer,{{ field.CamelCaseName }});
            {%- when 'ushort' -%}
            BinSerialize.WriteUShort(ref buffer,{{ field.CamelCaseName }});
            {%- when 'int' -%}
            BinSerialize.WriteInt(ref buffer,{{ field.CamelCaseName }});
            {%- when 'uint' -%}
            BinSerialize.WriteUInt(ref buffer,{{ field.CamelCaseName }});
            {%- when 'long' -%}
            BinSerialize.WriteLong(ref buffer,{{ field.CamelCaseName }});
            {%- when 'ulong' -%}
            BinSerialize.WriteULong(ref buffer,{{ field.CamelCaseName }});
            {%- when 'float' -%}
            BinSerialize.WriteFloat(ref buffer,{{ field.CamelCaseName }});
            {%- when 'double' -%}
            BinSerialize.WriteDouble(ref buffer,{{ field.CamelCaseName }});
            {%- endcase -%}
        {%- endif -%}
    {%- endif -%}
{%- endfor -%}
            /* PayloadByteSize = {{ msg.PayloadByteSize }} */;
        }

        public void Accept(IVisitor visitor)
        {
{%- for field in msg.Fields -%}
{%- if field.IsEnum -%}
    {%- if field.IsArray -%}
        {%- case field.Type -%}
            {%- when 'sbyte' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, (index, v, f, t) =>
            {
                var tmp = (sbyte){{ field.CamelCaseName }}[index];
                Int8Type.Accept(v,f,t, ref tmp);
                {{ field.CamelCaseName }}[index] = ({{ field.EnumCamelCaseName }})tmp;
            });
            {%- when 'byte' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, (index, v, f, t) =>
            {
                var tmp = (byte){{ field.CamelCaseName }}[index];
                UInt8Type.Accept(v, f, t, ref tmp);
                {{ field.CamelCaseName }}[index] = ({{ field.EnumCamelCaseName }})tmp;
            });
            {%- when 'short' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, (index, v, f, t) =>
            {
                var tmp = (short){{ field.CamelCaseName }}[index];
                Int16Type.Accept(v, f, t, ref tmp));
                {{ field.CamelCaseName }}[index] = ({{ field.EnumCamelCaseName }})tmp;
            });
            {%- when 'ushort' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, (index, v, f, t) =>
            {
                var tmp = (ushort){{ field.CamelCaseName }}[index];
                UInt16Type.Accept(v, f, t, ref tmp);
                {{ field.CamelCaseName }}[index] = ({{ field.EnumCamelCaseName }})tmp;
            });
            {%- when 'int' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, (index, v, f, t) =>
            {
                var tmp = (int){{ field.CamelCaseName }}[index];
                Int32Type.Accept(v, f, t, ref tmp);
                {{ field.CamelCaseName }}[index] = ({{ field.EnumCamelCaseName }})tmp;
            });
            {%- when 'uint' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, (index, v, f, t) =>
            {
                var tmp = (uint){{ field.CamelCaseName }}[index];
                UInt32Type.Accept(v, f, t, ref tmp);
                {{ field.CamelCaseName }}[index] = ({{ field.EnumCamelCaseName }})tmp;
            });
            {%- when 'long' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field,  (index, v, f, t) =>
            {
                var tmp = (long){{ field.CamelCaseName }}[index];
                Int64Type.Accept(v, f, t, ref tmp);
                {{ field.CamelCaseName }}[index] = ({{ field.EnumCamelCaseName }})tmp;
            });
            {%- when 'ulong' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field,  (index, v, f, t) =>
            {
                var tmp = (ulong){{ field.CamelCaseName }}[index];
                UInt64Type.Accept(v, f, t, ref tmp);
                {{ field.CamelCaseName }}[index] = ({{ field.EnumCamelCaseName }})tmp;
            });
            {%- when 'char' -%}
            {%- when 'float' -%}
            {%- when 'double' -%}
            ERROR => ENUM as 'float' or 'char' or 'double' ???????
            
        {%- endcase -%}
    {%- else -%}
        {%- case field.Type -%}
            {%- when 'sbyte' -%}
            var tmp{{ field.CamelCaseName }} = (sbyte){{ field.CamelCaseName }};
            Int8Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref tmp{{ field.CamelCaseName }});
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})tmp{{ field.CamelCaseName }};
            {%- when 'byte' -%}
            var tmp{{ field.CamelCaseName }} = (byte){{ field.CamelCaseName }};
            UInt8Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref tmp{{ field.CamelCaseName }});
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})tmp{{ field.CamelCaseName }};
            {%- when 'short' -%}
            var tmp{{ field.CamelCaseName }} = (short){{ field.CamelCaseName }};
            Int16Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref tmp{{ field.CamelCaseName }});
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})tmp{{ field.CamelCaseName }};
            {%- when 'ushort' -%}
            var tmp{{ field.CamelCaseName }} = (ushort){{ field.CamelCaseName }};
            UInt16Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref tmp{{ field.CamelCaseName }});
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})tmp{{ field.CamelCaseName }};
            {%- when 'int' -%}
            var tmp{{ field.CamelCaseName }} = (int){{ field.CamelCaseName }};
            Int32Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref tmp{{ field.CamelCaseName }});
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})tmp{{ field.CamelCaseName }};
            {%- when 'uint' -%}
            var tmp{{ field.CamelCaseName }} = (uint){{ field.CamelCaseName }};
            UInt32Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref tmp{{ field.CamelCaseName }});
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})tmp{{ field.CamelCaseName }};
            {%- when 'long' -%}
            var tmp{{ field.CamelCaseName }} = (long){{ field.CamelCaseName }};
            Int64Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref tmp{{ field.CamelCaseName }});
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})tmp{{ field.CamelCaseName }};
            {%- when 'ulong' -%}
            var tmp{{ field.CamelCaseName }} = (ulong){{ field.CamelCaseName }};
            UInt64Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref tmp{{ field.CamelCaseName }});
            {{ field.CamelCaseName }} = ({{ field.EnumCamelCaseName }})tmp{{ field.CamelCaseName }};
            {%- when 'char' -%}
            {%- when 'float' -%}
            {%- when 'double' -%}
                ERROR => ENUM as 'float' or 'double' ???????
        {%- endcase -%}
    {%- endif -%}
{%- else -%}
    {%- if field.IsArray -%}
        {%- case field.Type -%}
            {%- when 'char' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field,  
                (index, v, f, t) => CharType.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));
            {%- when 'sbyte' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field,  
                (index, v, f, t) => Int8Type.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));
            {%- when 'byte' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => UInt8Type.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));    
            {%- when 'short' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => Int16Type.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));    
            {%- when 'ushort' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => UInt16Type.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));    
            {%- when 'int' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => Int32Type.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));
            {%- when 'uint' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => UInt32Type.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));    
            {%- when 'long' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => Int64Type.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));    
            {%- when 'ulong' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => UInt64Type.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));    
            {%- when 'float' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => FloatType.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));
            {%- when 'double' -%}
            ArrayType.Accept(visitor,{{ field.CamelCaseName }}Field, 
                (index, v, f, t) => DoubleType.Accept(v, f, t, ref {{ field.CamelCaseName }}[index]));    
        {%- endcase -%}
    {%- else -%}
        {%- case field.Type -%}
            {%- when 'char' -%}
            CharType.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});
            {%- when 'sbyte' -%}
            Int8Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});                
            {%- when 'byte' -%}
            UInt8Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});    
            {%- when 'short' -%}
            Int16Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});
            {%- when 'ushort' -%}
            UInt16Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});    
            {%- when 'int' -%}
            Int32Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});    
            {%- when 'uint' -%}
            UInt32Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});    
            {%- when 'long' -%}
            Int64Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});    
            {%- when 'ulong' -%}
            UInt64Type.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});    
            {%- when 'float' -%}
            FloatType.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});    
            {%- when 'double' -%}
            DoubleType.Accept(visitor,{{ field.CamelCaseName }}Field, ref {{ field.FieldCaseName }});
        {%- endcase -%}
    {%- endif -%}
{%- endif -%}
{%- endfor -%}    
        }

    {%- for field in msg.Fields -%}
        /// <summary>
        {%- for line in field.Desc -%}
        /// {{ line }}
        {%- endfor -%}
        /// OriginName: {{ field.Name }}, Units: {{ field.Units }}, IsExtended: {{ field.IsExtended }}
        /// </summary>
        public static readonly Field {{ field.CamelCaseName }}Field = new Field.Builder()
            .Name(nameof({{ field.CamelCaseName }}))
            .Title({% if field.Display %}"{{ field.Display }}"{% else %}"{{ field.Name }}"{%- endif %})
            .Description({% if field.EscDesc %}"{{ field.EscDesc }}"{% else %}string.Empty{%- endif %})
            {%- if field.PrintFormat -%}.FormatString("{{ field.PrintFormat }}"){%- endif -%}
            {%- if field.Units -%}.Units(@"{{ field.Units }}"){%- endif -%}
    {%- if field.IsEnum -%}
        {%- if field.IsArray -%}
            {%- case field.Type -%}
                {%- when 'sbyte' -%}
            .DataType(new ArrayType(new Int8Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(sbyte)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(sbyte)x).Max()),{{ field.ArrayLength }}))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(sbyte)x))
                {%- when 'byte' -%}
            .DataType(new ArrayType(new UInt8Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(byte)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(byte)x).Max()),{{ field.ArrayLength }}))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(byte)x))
                {%- when 'short' -%}
            .DataType(new ArrayType(new Int16Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(short)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(short)x).Max()),{{ field.ArrayLength }}))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(short)x))
                {%- when 'ushort' -%}
            .DataType(new ArrayType(new UInt16Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(ushort)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(ushort)x).Max()),{{ field.ArrayLength }}))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(ushort)x))
                {%- when 'int' -%}
            .DataType(new ArrayType(new Int32Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(int)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(int)x).Max()),{{ field.ArrayLength }}))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(int)x))
                {%- when 'uint' -%}
            .DataType(new ArrayType(new UInt32Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(uint)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(uint)x).Max()),{{ field.ArrayLength }}))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(uint)x))
                {%- when 'long' -%}
            .DataType(new ArrayType(new Int64Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(long)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(long)x).Max()),{{ field.ArrayLength }}))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(long)x))
                {%- when 'ulong' -%}
            .DataType(new ArrayType(new UInt64Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(ulong)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(ulong)x).Max()),{{ field.ArrayLength }}))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(ulong)x))
                {%- when 'char' -%}
                {%- when 'float' -%}
                {%- when 'double' -%}
                    ERROR => ENUM as 'float' or 'double' ???????
            {%- endcase -%}
        {%- else -%}
            {%- case field.Type -%}
                {%- when 'sbyte' -%}
            .DataType(new Int8Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(sbyte)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(sbyte)x).Max()))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(sbyte)x))
                {%- when 'byte' -%}
            .DataType(new UInt8Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(byte)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(byte)x).Max()))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(byte)x))
                {%- when 'short' -%}
            .DataType(new Int16Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(short)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(short)x).Max()))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(short)x))
                {%- when 'ushort' -%}
            .DataType(new UInt16Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(ushort)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(ushort)x).Max()))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(ushort)x))
                {%- when 'int' -%}
            .DataType(new Int32Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(int)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(int)x).Max()))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(int)x))
                {%- when 'uint' -%}
            .DataType(new UInt32Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(uint)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(uint)x).Max()))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(uint)x))
                {%- when 'long' -%}
            .DataType(new Int64Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(long)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(long)x).Max()))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(long)x))
                {%- when 'ulong' -%}
            .DataType(new UInt64Type({{ field.EnumCamelCaseName }}Helper.GetValues(x=>(ulong)x).Min(),{{ field.EnumCamelCaseName }}Helper.GetValues(x=>(ulong)x).Max()))
            .Enum({{ field.EnumCamelCaseName }}Helper.GetEnumValues(x=>(ulong)x))
                {%- when 'char' -%}
                {%- when 'float' -%}
                {%- when 'double' -%}
                    ERROR => ENUM as 'float' or 'double' ???????
            {%- endcase -%}
        {%- endif -%}
    {% else %}
        {%- if field.IsArray -%}
            {%- case field.Type -%}
                {%- when 'char' -%}
            .DataType(new ArrayType(CharType.Ascii,{{ field.ArrayLength }}))
                {%- when 'sbyte' -%}
            .DataType(new ArrayType(Int8Type.Default,{{ field.ArrayLength }}))
                {%- when 'byte' -%}
            .DataType(new ArrayType(UInt8Type.Default,{{ field.ArrayLength }}))
                {%- when 'short' -%}
            .DataType(new ArrayType(Int16Type.Default,{{ field.ArrayLength }}))
                {%- when 'ushort' -%}
            .DataType(new ArrayType(UInt16Type.Default,{{ field.ArrayLength }}))
                {%- when 'int' -%}
            .DataType(new ArrayType(Int32Type.Default,{{ field.ArrayLength }}))        
                {%- when 'uint' -%}
            .DataType(new ArrayType(UInt32Type.Default,{{ field.ArrayLength }}))        
                {%- when 'long' -%}
            .DataType(new ArrayType(Int64Type.Default,{{ field.ArrayLength }}))        
                {%- when 'ulong' -%}
            .DataType(new ArrayType(UInt64Type.Default,{{ field.ArrayLength }}))            
                {%- when 'float' -%}
            .DataType(new ArrayType(FloatType.Default,{{ field.ArrayLength }}))        
                {%- when 'double' -%}
            .DataType(new ArrayType(DoubleType.Default,{{ field.ArrayLength }}))        
            {%- endcase -%}
        {%- else -%}
            {%- case field.Type -%}
                {%- when 'char' -%}
            .DataType(CharType.Ascii)
                {%- when 'sbyte' -%}
            .DataType(Int8Type.Default)
                {%- when 'byte' -%}
            .DataType(UInt8Type.Default)
                {%- when 'short' -%}
            .DataType(Int16Type.Default)
                {%- when 'ushort' -%}
            .DataType(UInt16Type.Default)
                {%- when 'int' -%}
            .DataType(Int32Type.Default)
                {%- when 'uint' -%}
            .DataType(UInt32Type.Default)
                {%- when 'long' -%}
            .DataType(Int64Type.Default)
                {%- when 'ulong' -%}
            .DataType(UInt64Type.Default)
                {%- when 'float' -%}
            .DataType(FloatType.Default)
                {%- when 'double' -%}
            .DataType(DoubleType.Default)
            {%- endcase -%}
        {%- endif -%}
    {%- endif -%}
        .Build();
    {%- if field.IsEnum -%}
        {%- if field.IsArray -%}
            {%- if field.IsTheLargestArrayInMessage -%}
        public const int {{ field.CamelCaseName }}MaxItemsCount = {{ field.ArrayLength }};    
        public {{ field.EnumCamelCaseName }}[] {{ field.CamelCaseName }} { get; } = new {{ field.EnumCamelCaseName }}[{{ field.ArrayLength }}];
            {%- else -%}
        public const int {{ field.CamelCaseName }}MaxItemsCount = {{ field.ArrayLength }};
        public {{ field.EnumCamelCaseName }}[] {{ field.CamelCaseName }} { get; } = new {{ field.EnumCamelCaseName }}[{{ field.ArrayLength }}];
            {%- endif -%}
        {%- else -%}
        private {{ field.EnumCamelCaseName }} {{ field.FieldCaseName }};
        public {{ field.EnumCamelCaseName }} {{ field.CamelCaseName }} { get => {{ field.FieldCaseName }}; set => {{ field.FieldCaseName }} = value; } 
       {%- endif -%}
    {%- else -%}
        {%- if field.IsArray -%}
            {%- if field.IsTheLargestArrayInMessage -%}
        public const int {{ field.CamelCaseName }}MaxItemsCount = {{ field.ArrayLength }};
        public {{ field.Type }}[] {{ field.CamelCaseName }} { get; } = new {{ field.Type }}[{{ field.ArrayLength }}];
        [Obsolete("This method is deprecated. Use Get{{ field.CamelCaseName }}MaxItemsCount instead.")]
        public byte Get{{ field.CamelCaseName }}MaxItemsCount() => {{ field.ArrayLength }};
            {%- else -%}
        public const int {{ field.CamelCaseName }}MaxItemsCount = {{ field.ArrayLength }};
        public {{ field.Type }}[] {{ field.CamelCaseName }} { get; } = new {{ field.Type }}[{{ field.ArrayLength }}];
            {%- endif -%}
        {%- else -%}
        private {{ field.Type }} {{ field.FieldCaseName }};
        public {{ field.Type }} {{ field.CamelCaseName }} { get => {{ field.FieldCaseName }}; set => {{ field.FieldCaseName }} = value; }
        {%- endif -%}
    {%- endif -%}
    {%- endfor -%}
    }
{%- endfor -%}




        


#endregion


}
